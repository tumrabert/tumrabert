name: Update README with Portfolio Data

on:
  schedule:
    # Runs every day at 5 AM UTC (12 PM midnight Bangkok time GMT+7)
    - cron: '0 17 * * *'
  workflow_dispatch: # Allows manual trigger
  push:
    branches: [ main ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cat > package.json << 'EOF'
        {
          "name": "readme-updater",
          "version": "1.0.0",
          "dependencies": {
            "axios": "^1.6.0"
          }
        }
        EOF
        npm install
        
    - name: Update README
      run: |
        cat > update-readme.js << 'EOF'
        const axios = require('axios');
        const fs = require('fs');

        async function updateReadme() {
          try {
            console.log('Fetching portfolio data...');
            const response = await axios.get('https://tumrabert.com/api/portfolio');
            
            // Validate API response
            if (!response.data || !response.data.success || !response.data.data) {
              throw new Error('Invalid API response structure');
            }
            
            const data = response.data.data;
            
            const intro = data.intro || {};
            const workExperiences = data.workExperiences || [];
            const technologies = data.technologies || [];
            const projects = data.displayProjects || [];
            
            // Group technologies by category with validation
            const groupedTech = technologies.reduce((acc, tech) => {
              if (tech && tech.category && tech.name) {
                if (!acc[tech.category]) acc[tech.category] = [];
                acc[tech.category].push(tech.name);
              }
              return acc;
            }, {});
            
            // Helper function to create safe badge URLs
            function createBadgeUrl(tech) {
              const safeTech = encodeURIComponent(tech.replace(/[^a-zA-Z0-9\s]/g, ''));
              const logoName = tech.toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .replace(/\s+/g, '');
              return `![${tech}](https://img.shields.io/badge/-${safeTech}-000000?style=flat-square&logo=${logoName}&logoColor=white)`;
            }
            
            const readme = `# Hi there, I'm ${intro.name || 'Tanakit'} ğŸ‘‹

![Profile Banner](https://github.com/tumrabert/tumrabert/blob/main/assets/banner.gif?raw=true)

## ğŸš€ About Me

**${intro.title || 'AI Software Engineer'}** | ${intro.location || 'Bangkok, Thailand'} ğŸ“

> ${intro.description?.substring(0, 200) || 'Passionate about building intelligent systems that solve real-world problems'}...

### ğŸ“Š Quick Stats
- ğŸ¯ **Experience**: ${intro.quickFacts?.yearOfExperience || '3'}+ years
- ğŸ› ï¸ **Projects**: ${intro.quickFacts?.projectsCount || '10'}+ completed
- ğŸ’» **Technologies**: ${intro.quickFacts?.technologiesCount || '20'}+ mastered
- ğŸ® **Hobbies**: ${intro.quickFacts?.hobbies?.join(', ') || 'Running, Music, Gaming'}

## ğŸ’¼ Current Role

${workExperiences.length > 0 && workExperiences[0] ? `**${workExperiences[0].position || 'Software Engineer'}** @ **${workExperiences[0].company || 'Tech Company'}**  
ğŸ“… ${workExperiences[0].start || 'Present'} - ${workExperiences[0].end || 'Present'}

${workExperiences[0].details && Array.isArray(workExperiences[0].details) ? workExperiences[0].details.map(detail => `- ${detail}`).join('\n') : ''}` : 'Currently seeking new opportunities'}

## ğŸ› ï¸ Tech Stack

${Object.entries(groupedTech).length > 0 ? Object.entries(groupedTech).map(([category, techs]) => `
### ${category}
${techs && Array.isArray(techs) ? techs.map(tech => createBadgeUrl(tech)).join(' ') : ''}
`).join('') : '### Programming Languages\nWorking with various technologies to build amazing projects!'}

## ğŸŒŸ Featured Projects

${projects && Array.isArray(projects) && projects.length > 0 ? projects
  .filter(p => p && !p.hide)
  .slice(0, 3)
  .map(project => `
### ğŸ”— [${project.name || 'Untitled Project'}](${project.demo || project.github || '#'})

${project.description ? project.description.substring(0, 150) + '...' : 'Amazing project that showcases innovative solutions and technical expertise.'}

**Tech Stack**: ${project.technologies && Array.isArray(project.technologies) ? project.technologies.map(tech => `\`${tech}\``).join(' ') : 'Various technologies'}

${project.github ? `[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=flat-square&logo=github)](${project.github})` : ''} ${project.demo ? `[![Demo](https://img.shields.io/badge/-Live_Demo-FF6B6B?style=flat-square&logo=vercel)](${project.demo})` : ''}
`).join('') : `
### ğŸš€ Coming Soon
Currently working on exciting projects that will be showcased here soon!
`}

## ğŸ“ˆ GitHub Analytics

<div align="center">
  <img height="180em" src="https://github-readme-stats.vercel.app/api?username=tumrabert&show_icons=true&theme=radical&include_all_commits=true&count_private=true"/>
  <img height="180em" src="https://github-readme-stats.vercel.app/api/top-langs/?username=tumrabert&layout=compact&langs_count=8&theme=radical"/>
</div>

<div align="center">
  <img src="https://github-readme-streak-stats.herokuapp.com/?user=tumrabert&theme=radical" alt="GitHub Streak" />
</div>

## ğŸ† GitHub Trophies

<div align="center">
  <img src="https://github-profile-trophy.vercel.app/?username=tumrabert&theme=radical&no-frame=false&no-bg=false&margin-w=4&row=1" alt="GitHub Trophies" />
</div>

## ğŸ“« Let's Connect

<div align="center">

[![Email](https://img.shields.io/badge/-${intro.email || 'email@domain.com'}-D14836?style=for-the-badge&logo=gmail&logoColor=white)](mailto:${intro.email || 'email@domain.com'})
[![LinkedIn](https://img.shields.io/badge/-LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white)](https://${intro.linkedin ? intro.linkedin.replace('linkedin.com/in/', 'linkedin.com/in/') : 'linkedin.com/in/tumrabert'})
[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=for-the-badge&logo=github)](https://github.com/tumrabert)
[![Portfolio](https://img.shields.io/badge/-Portfolio-FF6B6B?style=for-the-badge&logo=vercel)](https://tumrabert.com)

</div>

## ğŸ’¡ Fun Facts

- ğŸ”„ This README auto-updates daily using GitHub Actions
- ğŸ“Š Data is synced from my portfolio API: \`https://tumrabert.com/api/portfolio\`
- ğŸ¯ Always learning and building cool stuff!

---

<div align="center">
  <img src="https://komarev.com/ghpvc/?username=tumrabert&color=blueviolet&style=flat-square&label=Profile+Views" alt="Profile views" />
  <br><br>
  <b>â­ If you like my work, consider giving a star to my repositories!</b>
</div>

---
*Last updated: ${new Date().toLocaleString('en-US', { 
              timeZone: 'Asia/Bangkok', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              timeZoneName: 'short'
            })}*`;

            fs.writeFileSync('README.md', readme);
            console.log('README.md updated successfully!');
            
          } catch (error) {
            console.error('Error updating README:', error.message);
            console.error('Full error details:', error);
            
            // Create a fallback README if API fails
            const fallbackReadme = `# Hi there, I'm Tanakit ğŸ‘‹

## ğŸš€ About Me

**AI Software Engineer** | Bangkok, Thailand ğŸ“

> Passionate about building intelligent systems that solve real-world problems...

## ğŸ“« Let's Connect

[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=for-the-badge&logo=github)](https://github.com/tumrabert)
[![LinkedIn](https://img.shields.io/badge/-LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white)](https://linkedin.com/in/tumrabert)
[![Portfolio](https://img.shields.io/badge/-Portfolio-FF6B6B?style=for-the-badge&logo=vercel)](https://tumrabert.com)

---
*API temporarily unavailable. README will be updated when service is restored.*
*Last attempted update: ${new Date().toLocaleString('en-US', { 
              timeZone: 'Asia/Bangkok', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              timeZoneName: 'short'
            })}*`;
            
            fs.writeFileSync('README.md', fallbackReadme);
            console.log('Fallback README.md created due to API error');
          }
        }

        updateReadme();
        EOF
        node update-readme.js
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ¤– Auto-update README with latest portfolio data"
        git push
