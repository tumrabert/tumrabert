name: Update README with Portfolio Data

on:
  schedule:
    # Runs every day at 5 AM UTC (12 PM midnight Bangkok time GMT+7)
    - cron: '0 17 * * *'
  workflow_dispatch: # Allows manual trigger
  push:
    branches: [ main ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install axios
        
    - name: Create update script
      run: |
        cat > update-readme.js << 'SCRIPT_EOF'
        const axios = require('axios');
        const fs = require('fs');

        async function updateReadme() {
          try {
            console.log('Fetching portfolio data...');
            const response = await axios.get('https://tumrabert.com/api/portfolio');
            
            if (!response.data || !response.data.success || !response.data.data) {
              throw new Error('Invalid API response structure');
            }
            
            const data = response.data.data;
            const intro = data.intro || {};
            const workExperiences = data.workExperiences || [];
            const education = data.education || [];
            const technologies = data.technologies || [];
            const projects = data.displayProjects || [];
            
            // Read template file
            const template = fs.readFileSync('.github/templates/readme-template.md', 'utf8');
            
            // Group technologies by category
            const groupedTech = technologies.reduce((acc, tech) => {
              if (tech && tech.category && tech.name) {
                if (!acc[tech.category]) acc[tech.category] = [];
                acc[tech.category].push(tech.name);
              }
              return acc;
            }, {});
            
            function createBadgeUrl(tech) {
              const safeTech = encodeURIComponent(tech.replace(/[^a-zA-Z0-9\s]/g, ''));
              const logoName = tech.toLowerCase().replace(/[^a-z0-9]/g, '').replace(/\s+/g, '');
              return `![${tech}](https://img.shields.io/badge/-${safeTech}-000000?style=flat-square&logo=${logoName}&logoColor=white)`;
            }
            
            // Build dynamic content
            let currentRole = 'Currently seeking new opportunities';
            if (workExperiences.length > 0 && workExperiences[0]) {
              const exp = workExperiences[0];
              currentRole = '**' + (exp.position || 'Software Engineer') + '** @ **' + (exp.company || 'Tech Company') + '**' + String.fromCharCode(10);
              currentRole += 'ðŸ“… ' + (exp.start || 'Present') + ' - ' + (exp.end || 'Present') + String.fromCharCode(10) + String.fromCharCode(10);
              if (exp.details && Array.isArray(exp.details)) {
                currentRole += exp.details.map(detail => '- ' + detail).join(String.fromCharCode(10));
              }
            }

            let techStack = '### Programming Languages' + String.fromCharCode(10) + 'Working with various technologies to build amazing projects!';
            if (Object.entries(groupedTech).length > 0) {
              techStack = Object.entries(groupedTech).map(([category, techs]) => {
                const badges = techs && Array.isArray(techs) ? techs.map(tech => createBadgeUrl(tech)).join(' ') : '';
                return String.fromCharCode(10) + '### ' + category + String.fromCharCode(10) + badges;
              }).join('');
            }

            // Build previous experience section
            let previousExperience = 'No previous work experience listed.';
            if (workExperiences.length > 1) {
              previousExperience = workExperiences.slice(1).map((exp, index) => {
                let expSection = '### ' + (exp.position || 'Position') + ' @ ' + (exp.company || 'Company');
                expSection += String.fromCharCode(10) + 'ðŸ“… ' + (exp.start || 'Start Date') + ' - ' + (exp.end || 'End Date');
                if (exp.details && Array.isArray(exp.details)) {
                  expSection += String.fromCharCode(10) + String.fromCharCode(10) + exp.details.map(detail => '- ' + detail).join(String.fromCharCode(10));
                }
                return expSection;
              }).join(String.fromCharCode(10) + String.fromCharCode(10));
            }

            // Build education section
            let educationSection = 'Education information not available.';
            if (education && Array.isArray(education) && education.length > 0) {
              educationSection = education.map(edu => {
                let eduSection = '### ' + (edu.degree || 'Degree') + ' in ' + (edu.field || 'Field of Study');
                eduSection += String.fromCharCode(10) + '**' + (edu.school || 'Institution') + '**';
                if (edu.location) {
                  eduSection += ' | ' + edu.location;
                }
                if (edu.startYear || edu.endYear) {
                  eduSection += String.fromCharCode(10) + 'ðŸ“… ' + (edu.startYear || 'Start') + ' - ' + (edu.endYear || 'End');
                }
                if (edu.gpa) {
                  eduSection += String.fromCharCode(10) + '**GPA**: ' + edu.gpa;
                }
                if (edu.achievements && Array.isArray(edu.achievements)) {
                  eduSection += String.fromCharCode(10) + String.fromCharCode(10) + '**Achievements**:' + String.fromCharCode(10);
                  eduSection += edu.achievements.map(achievement => '- ' + achievement).join(String.fromCharCode(10));
                }
                return eduSection;
              }).join(String.fromCharCode(10) + String.fromCharCode(10));
            }

            let featuredProjects = '### ðŸš€ Coming Soon' + String.fromCharCode(10) + 'Currently working on exciting projects that will be showcased here soon!';
            if (projects && Array.isArray(projects) && projects.length > 0) {
              featuredProjects = projects.filter(p => p && !p.hide).slice(0, 3).map(project => {
                const name = project.name || 'Untitled Project';
                const url = project.demo || project.github || '#';
                const desc = project.description ? project.description.substring(0, 150) + '...' : 'Amazing project that showcases innovative solutions and technical expertise.';
                const techs = project.technologies && Array.isArray(project.technologies) ? project.technologies.map(tech => '`' + tech + '`').join(' ') : 'Various technologies';
                const githubBadge = project.github ? '[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=flat-square&logo=github)](' + project.github + ')' : '';
                const demoBadge = project.demo ? '[![Demo](https://img.shields.io/badge/-Live_Demo-FF6B6B?style=flat-square&logo=vercel)](' + project.demo + ')' : '';
                return String.fromCharCode(10) + '### ðŸ”— [' + name + '](' + url + ')' + String.fromCharCode(10) + String.fromCharCode(10) + desc + String.fromCharCode(10) + String.fromCharCode(10) + '**Tech Stack**: ' + techs + String.fromCharCode(10) + String.fromCharCode(10) + githubBadge + ' ' + demoBadge;
              }).join('');
            }

            // Replace template placeholders
            const email = intro.email || 'email@domain.com';
            const linkedin = intro.linkedin ? intro.linkedin.replace('linkedin.com/in/', 'linkedin.com/in/') : 'linkedin.com/in/tumrabert';
            
            const readme = template
              .replace(/{{name}}/g, intro.name || 'Tanakit')
              .replace(/{{title}}/g, intro.title || 'AI Software Engineer')
              .replace(/{{location}}/g, intro.location || 'Bangkok, Thailand')
              .replace(/{{description}}/g, intro.description || 'Passionate about building intelligent systems that solve real-world problems')
              .replace(/{{experience}}/g, intro.quickFacts?.yearOfExperience || '3')
              .replace(/{{projectsCount}}/g, intro.quickFacts?.projectsCount || '10')
              .replace(/{{technologiesCount}}/g, intro.quickFacts?.technologiesCount || '20')
              .replace(/{{hobbies}}/g, intro.quickFacts?.hobbies?.join(', ') || 'Running, Music, Gaming')
              .replace(/{{currentRole}}/g, currentRole)
              .replace(/{{previousExperience}}/g, previousExperience)
              .replace(/{{education}}/g, educationSection)
              .replace(/{{techStack}}/g, techStack)
              .replace(/{{featuredProjects}}/g, featuredProjects)
              .replace(/{{email}}/g, email)
              .replace(/{{linkedin}}/g, linkedin)
              .replace(/{{lastUpdated}}/g, new Date().toLocaleString('en-US', { 
                timeZone: 'Asia/Bangkok', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                timeZoneName: 'short' 
              }));

            fs.writeFileSync('README.md', readme);
            console.log('README.md updated successfully!');
            
          } catch (error) {
            console.error('Error updating README:', error.message);
            const timestamp = new Date().toLocaleString('en-US', { 
              timeZone: 'Asia/Bangkok', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit', 
              timeZoneName: 'short' 
            });
            const fallbackReadme = '# Hi there, I am Tanakit ðŸ‘‹' + String.fromCharCode(10) + String.fromCharCode(10) +
              '## ðŸš€ About Me' + String.fromCharCode(10) +
              '**AI Software Engineer** | Bangkok, Thailand ðŸ“' + String.fromCharCode(10) +
              '> Passionate about building intelligent systems that solve real-world problems...' + String.fromCharCode(10) + String.fromCharCode(10) +
              '## ðŸ“« Let us Connect' + String.fromCharCode(10) +
              '[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=for-the-badge&logo=github)](https://github.com/tumrabert)' + String.fromCharCode(10) +
              '[![LinkedIn](https://img.shields.io/badge/-LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white)](https://linkedin.com/in/tumrabert)' + String.fromCharCode(10) +
              '[![Portfolio](https://img.shields.io/badge/-Portfolio-FF6B6B?style=for-the-badge&logo=vercel)](https://tumrabert.com)' + String.fromCharCode(10) + String.fromCharCode(10) +
              '---' + String.fromCharCode(10) +
              '*API temporarily unavailable. README will be updated when service is restored.*' + String.fromCharCode(10) +
              '*Last attempted update: ' + timestamp + '*';
            
            fs.writeFileSync('README.md', fallbackReadme);
            console.log('Fallback README.md created due to API error');
          }
        }

        updateReadme();
        SCRIPT_EOF

    - name: Run update script
      run: node update-readme.js
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update README with latest portfolio data"
        git push